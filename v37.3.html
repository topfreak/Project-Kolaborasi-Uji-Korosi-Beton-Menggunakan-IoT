<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPRCP Master Hub v37.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .tab-active { background-color: #10b981; color: white; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.2); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        table thead th { position: sticky; top: 0; z-index: 20; background: #f8fafc; white-space: nowrap; cursor: pointer; user-select: none; transition: background-color 0.2s; }
        table thead th:hover { background-color: #e2e8f0; }
        .sticky-col { position: sticky; left: 0; background: white; z-index: 30; border-right: 2px solid #f1f5f9; }
        tr:hover .sticky-col { background: #f0fdf4; }
        .table-container { max-height: 70vh; overflow: auto; -webkit-overflow-scrolling: touch; }
        
        /* Animasi Loading */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        .pulse-ring {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            background-color: rgba(16, 185, 129, 0.6);
        }
    </style>
</head>
<body class="text-slate-900 text-sm md:text-base overflow-x-hidden bg-slate-50">

    <div id="loader" class="fixed inset-0 z-[99] bg-slate-950 flex flex-col items-center justify-center text-white transition-opacity duration-500">
        <div class="relative w-16 h-16 mb-4">
            <div class="pulse-ring"></div>
            <div class="relative w-16 h-16 border-4 border-emerald-500 border-t-transparent rounded-full animate-spin"></div>
        </div>
        <h2 class="text-emerald-500 font-bold tracking-tight text-xl italic text-center uppercase tracking-tighter">SPRCP<br><span class="text-[9px] text-slate-500 font-medium tracking-normal not-italic uppercase tracking-[0.3em]">System V37.3</span></h2>
    </div>

    <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>

    <div class="min-h-screen flex flex-col lg:flex-row">
        
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-72 bg-slate-900 text-white flex flex-col shadow-2xl transform -translate-x-full transition-transform duration-300 lg:translate-x-0 lg:static lg:h-screen lg:sticky lg:top-0 overflow-y-auto">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-tight">SPRCP<span class="text-emerald-400">.v37.3</span></h1>
                    <p class="text-[8px] text-slate-500 font-bold uppercase mt-1 tracking-widest leading-none">Smart Patch Repair<br>Cathodic Protection</p>
                </div>
                <button onclick="toggleSidebar()" class="lg:hidden text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            </div>

            <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
                <button id="btn-logs" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all hover:bg-slate-800 text-slate-400">
                    <i class="fas fa-database w-5"></i> <span data-i18n="nav_logs">Log Data</span>
                </button>
                <button id="btn-trend" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all hover:bg-slate-800 text-slate-400">
                    <i class="fas fa-chart-line w-5"></i> <span data-i18n="nav_trend">Grafik Potensial</span>
                </button>
                <button id="btn-current" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all hover:bg-slate-800 text-slate-400">
                    <i class="fas fa-bolt w-5"></i> <span data-i18n="nav_current">Arus & Densitas</span>
                </button>
                <button id="btn-setup" class="w-full flex items-center gap-4 px-6 py-4 rounded-2xl font-bold transition-all hover:bg-slate-800 text-slate-400">
                    <i class="fas fa-cog w-5"></i> <span data-i18n="nav_setup">Setup Riset</span>
                </button>
            </nav>

            <div class="p-6 border-t border-slate-800 bg-black/20">
                <div class="flex items-center gap-3 bg-slate-800/50 p-4 rounded-2xl border border-white/5">
                    <div id="status-dot" class="w-3 h-3 rounded-full bg-rose-500 animate-pulse"></div>
                    <div>
                        <p class="text-[9px] font-black uppercase text-slate-500 leading-none mb-1" data-i18n="sys_status">Status Sistem</p>
                        <p id="status-text" class="text-xs font-bold text-white uppercase tracking-tighter">OFF</p>
                    </div>
                </div>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-screen overflow-hidden w-full">
            <header class="bg-white border-b-4 border-emerald-500 px-4 md:px-8 py-4 flex justify-between items-center z-10 shadow-sm sticky top-0">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSidebar()" class="lg:hidden text-slate-700 bg-slate-100 p-2 rounded-lg hover:bg-slate-200 transition">
                        <i class="fas fa-bars text-lg"></i>
                    </button>
                    <div>
                        <h2 id="page-title" class="text-lg md:text-2xl font-black text-slate-800 uppercase italic tracking-tight truncate max-w-[150px] md:max-w-none">Data Monitoring</h2>
                        <p class="text-[9px] md:text-[10px] font-bold text-emerald-600 uppercase tracking-widest mt-0.5 italic">
                            <span data-i18n="last_sync">Sinkronisasi</span>: <span id="sync-time">...</span>
                        </p>
                    </div>
                </div>
                
                <div class="flex gap-2 md:gap-4 items-center">
                    <div class="bg-slate-100 p-1 rounded-lg flex border border-slate-200">
                        <button id="lang-id" class="px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all bg-white shadow-sm text-slate-800">ID</button>
                        <button id="lang-en" class="px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600">EN</button>
                    </div>
                    <div class="hidden md:block bg-slate-900 text-white px-4 py-2 rounded-xl text-[10px] font-black italic border-b-4 border-emerald-500 shadow-lg">
                        <span data-i18n="start_date">Mulai Riset</span>: <span id="display-start-date">N/A</span>
                    </div>
                </div>
            </header>

            <div id="content-area" class="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 md:space-y-10 custom-scrollbar bg-[#f8fafc]">
                
                <div id="tab-logs" class="space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-[2rem] border border-slate-200 shadow-sm grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_specimen">Benda Uji</label>
                            <select id="filter-bu" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-xs font-bold focus:border-emerald-500 outline-none">
                                <option value="ALL">Semua Benda Uji</option>
                                <option value="M1">M1</option><option value="M4">M4</option><option value="M10">M10</option><option value="M14">M14</option>
                                <option value="MK22">MK22</option><option value="MK21">MK21</option><option value="MK18">MK18</option><option value="MK17">MK17</option>
                            </select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_method">Metode</label>
                            <select id="filter-type" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-xs font-bold text-emerald-700 focus:border-emerald-500 outline-none"><option value="SACP">SACP</option><option value="HCP">HCP</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_sort">Urutan Waktu</label>
                            <select id="filter-sort" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-2.5 text-xs font-bold text-slate-700 focus:border-emerald-500 outline-none"><option value="DESC">Baru -> Lama</option><option value="ASC">Lama -> Baru</option></select>
                        </div>
                        <button id="btn-export" class="w-full bg-slate-900 text-white px-6 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center justify-center gap-2 hover:bg-slate-800 transition-all shadow-lg italic">
                            <i class="fas fa-file-excel text-emerald-500"></i> <span data-i18n="btn_export">Ekspor Excel</span>
                        </button>
                    </div>
                    <div class="bg-white rounded-[1.5rem] md:rounded-[2.5rem] border border-slate-200 shadow-xl overflow-hidden">
                        <div class="table-container custom-scrollbar">
                            <table class="w-full text-left text-[10px] border-collapse italic font-bold min-w-[1200px] md:min-w-[2000px]">
                                <thead id="table-head" class="bg-slate-50 font-black text-slate-400 uppercase tracking-tighter border-b border-slate-100"></thead>
                                <tbody id="table-body" class="divide-y divide-slate-50 text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-trend" class="hidden space-y-6">
                    <div class="bg-white p-4 md:p-6 rounded-[2rem] border border-slate-200 shadow-sm grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                        <div class="space-y-1 col-span-2 md:col-span-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_specimen">Benda Uji</label>
                            <select id="trend-bu" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold outline-none"><option value="ALL">Semua Benda Uji</option><option value="M1">M1</option><option value="M4">M4</option><option value="M10">M10</option><option value="M14">M14</option><option value="MK22">MK22</option><option value="MK21">MK21</option><option value="MK18">MK18</option><option value="MK17">MK17</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_method">Metode</label>
                            <select id="trend-method" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold text-emerald-700 outline-none"><option value="SACP">SACP</option><option value="HCP">HCP</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_datatype">Tipe Data</label>
                            <select id="trend-datatype" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold text-blue-700 outline-none"></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_tulangan">Tulangan</label>
                            <select id="trend-tulangan" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold outline-none"><option value="T1">T1</option><option value="T2">T2</option></select>
                        </div>
                        <div class="space-y-1 col-span-2 md:col-span-1">
                            <label class="text-[9px] font-black text-slate-400 uppercase ml-2 tracking-widest" data-i18n="lbl_interval">Interval</label>
                            <select id="trend-interval" class="w-full bg-slate-50 border border-slate-200 rounded-xl px-3 py-2 text-xs font-bold outline-none"><option value="1">Harian</option><option value="3">3 Hari</option><option value="7">7 Hari</option><option value="14">14 Hari</option></select>
                        </div>
                    </div>
                    <div class="bg-white p-4 md:p-8 rounded-[2rem] md:rounded-[3rem] border border-slate-200 shadow-xl">
                        <div id="chart-trend" class="w-full h-[400px] md:h-[550px]"></div>
                    </div>
                </div>

                <div id="tab-current" class="hidden space-y-6">
                    <div class="bg-slate-900 p-4 md:p-6 rounded-[2rem] shadow-xl border border-white/5 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase ml-2 tracking-widest" data-i18n="lbl_specimen">Benda Uji</label>
                            <select id="current-bu" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-xs font-bold text-emerald-400 outline-none"><option value="ALL">Semua Benda Uji</option><option value="M1">M1</option><option value="M4">M4</option><option value="M10">M10</option><option value="M14">M14</option><option value="MK22">MK22</option><option value="MK21">MK21</option><option value="MK18">MK18</option><option value="MK17">MK17</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase ml-2 tracking-widest" data-i18n="lbl_interval">Interval</label>
                            <select id="current-interval" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-xs font-bold text-white outline-none"><option value="1">Harian</option><option value="3">Per 3 Hari</option><option value="7">Per 7 Hari</option><option value="14">Per 14 Hari</option></select>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[9px] font-black text-slate-500 uppercase ml-2 tracking-widest" data-i18n="lbl_area">Luas (m²)</label>
                            <input type="number" id="input-surface-area" step="0.0001" value="0.05" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-2.5 text-xs font-bold text-white outline-none font-mono">
                        </div>
                    </div>
                    <div class="bg-slate-950 p-4 md:p-8 rounded-[2rem] md:rounded-[3rem] border-b-8 border-emerald-500 shadow-2xl">
                        <div id="chart-flow" class="w-full h-[300px] md:h-[350px]"></div>
                    </div>
                    <div class="bg-slate-950 p-4 md:p-8 rounded-[2rem] md:rounded-[3rem] border-b-8 border-blue-500 shadow-2xl">
                        <div id="chart-density" class="w-full h-[300px] md:h-[350px]"></div>
                    </div>
                </div>

                <div id="tab-setup" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-10">
                    <div class="bg-white p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] border border-slate-200 shadow-xl flex flex-col">
                        <h4 class="text-lg font-black uppercase italic mb-6 flex items-center gap-3 text-slate-800 leading-tight">
                            <i class="far fa-calendar-alt text-emerald-500"></i> <span data-i18n="nav_setup">Tanggal Mulai Riset</span>
                        </h4>
                        <input type="date" id="setup-start-date" class="w-full px-8 py-4 rounded-2xl border-2 border-slate-100 bg-slate-50 font-black outline-none focus:border-emerald-500 shadow-inner mb-6 transition-all">
                        <button id="btn-save-date" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] shadow-lg hover:scale-[1.02] active:scale-95 transition-all mt-auto" data-i18n="btn_save">Simpan Konfigurasi</button>
                    </div>
                    
                    <div class="bg-slate-900 p-6 md:p-10 rounded-[2rem] md:rounded-[3rem] text-white shadow-2xl border border-slate-800">
                        <h4 class="text-lg font-black uppercase italic mb-6 flex items-center gap-3 text-emerald-400">
                            <i class="fas fa-calculator"></i> <span data-i18n="calib_title">Kalibrasi Kanal (32-Slot)</span>
                        </h4>
                        
                        <div class="grid grid-cols-3 gap-3 mb-6">
                            <div>
                                <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Benda Uji</label>
                                <select id="calib-bu-select" class="w-full px-3 py-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-white focus:border-emerald-500 outline-none transition-all text-xs">
                                    <option value="M1">M1</option><option value="M4">M4</option><option value="M10">M10</option><option value="M14">M14</option>
                                    <option value="MK22">MK22</option><option value="MK21">MK21</option><option value="MK18">MK18</option><option value="MK17">MK17</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Metode</label>
                                <select id="calib-method-select" class="w-full px-3 py-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-emerald-400 focus:border-emerald-500 outline-none transition-all text-xs">
                                    <option value="SACP">SACP</option><option value="HCP">HCP</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1 block">Tulangan</label>
                                <select id="calib-tul-select" class="w-full px-3 py-3 bg-slate-800 border border-slate-700 rounded-xl font-bold text-blue-400 focus:border-emerald-500 outline-none transition-all text-xs">
                                    <option value="T1">T1</option><option value="T2">T2</option>
                                </select>
                            </div>
                        </div>

                        <div class="space-y-4 mb-8 bg-black/20 p-4 rounded-2xl border border-white/5">
                            <div class="flex justify-between items-center"><span class="text-[10px] font-black uppercase text-emerald-500" data-i18n="coeff_a">Koefisien A</span><input type="number" id="poly-a" step="0.00000001" class="bg-transparent text-right outline-none font-mono text-white w-1/2 border-b border-white/10 focus:border-emerald-500"></div>
                            <div class="flex justify-between items-center"><span class="text-[10px] font-black uppercase text-emerald-500" data-i18n="coeff_b">Koefisien B</span><input type="number" id="poly-b" step="0.0001" class="bg-transparent text-right outline-none font-mono text-white w-1/2 border-b border-white/10 focus:border-emerald-500"></div>
                            <div class="flex justify-between items-center"><span class="text-[10px] font-black uppercase text-emerald-500" data-i18n="coeff_c">Koefisien C</span><input type="number" id="poly-c" step="0.1" class="bg-transparent text-right outline-none font-mono text-white w-1/2 border-b border-white/10 focus:border-emerald-500"></div>
                        </div>
                        <button id="btn-save-calib" class="w-full bg-emerald-500 text-slate-900 py-4 rounded-2xl font-black uppercase text-[10px] tracking-[0.2em] shadow-xl hover:bg-emerald-400 hover:scale-[1.02] active:scale-95 transition-all" data-i18n="btn_send">Simpan Kalibrasi ke Alat</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js";

        // CONFIG FIREBASE
        const firebaseConfig = { 
            apiKey: "YOUR_API_KEY_HERE", 
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com", 
            databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com", 
            projectId: "YOUR_PROJECT_ID", 
            storageBucket: "YOUR_PROJECT_ID.appspot.com", 
            messagingSenderId: "YOUR_SENDER_ID", 
            appId: "YOUR_APP_ID" 
        };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getDatabase(app); const basePath = `YOUR_BASE_PATH_HERE`;

        let rawLogs = [], currentLogs = [], currentTab = 'logs', currentLang = 'id';
        let trendChart = null, flowChart = null, densityChart = null;
        let allCalibrations = {}; // Variabel global untuk menyimpan semua data kalibrasi

        const tableBody = document.getElementById('table-body'), tableHead = document.getElementById('table-head'), loader = document.getElementById('loader');

        // SIDEBAR TOGGLE
        window.toggleSidebar = () => { const sb = document.getElementById('sidebar'); const ov = document.getElementById('sidebar-overlay'); if(sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); } };

        // BAHASA
        const i18n = {
            id: { 
                nav_logs: "Log Data", nav_trend: "Grafik Potensial", nav_current: "Arus & Densitas", nav_setup: "Setup Riset", 
                sys_status: "Status Sistem", last_sync: "Sinkronisasi", start_date: "Mulai Riset", 
                lbl_specimen: "Benda Uji", lbl_method: "Metode", lbl_datatype: "Tipe Data", lbl_tulangan: "Tulangan", 
                lbl_interval: "Interval Waktu", lbl_sort: "Urutan Waktu", lbl_area: "Luas (m²)", 
                opt_daily: "Harian", opt_3days: "Per 3 Hari", opt_7days: "Per 7 Hari", opt_14days: "Per 14 Hari", opt_all: "Semua Benda Uji", 
                btn_export: "Ekspor Excel", btn_save: "Simpan Konfigurasi", btn_send: "Kirim Ke Perangkat", 
                axis_days: "Waktu Paparan (Hari)", axis_pot: "Potensial (mV vs CSE)", axis_flow: "Arus (mA)", axis_density: "Densitas Arus (mA/m²)", axis_depol: "Depolarisasi (mV)",
                calib_title: "Kalibrasi SPRCP", coeff_a: "Koefisien A", coeff_b: "Koefisien B", coeff_c: "Koefisien C", 
                rebar_1: "Tulangan 1", rebar_2: "Tulangan 2", lbl_on: "ON Potential", lbl_off: "Instant OFF", lbl_rest: "Rest Potential", lbl_depol: "Depolarisasi",
                th_time_ph1: "Waktu PH1", th_time_ph2: "Waktu PH2", th_time: "Waktu", th_sample: "Sampel", th_temp: "Suhu", th_zone: "Zona", 
                th_depol: "DEPOL",
                sort_new: "Baru -> Lama", sort_old: "Lama -> Baru", 
                title_pot_chart: "Grafik Potensial Korosi", 
                title_flow_chart: "Grafik Arus Listrik (Current Flow)", 
                title_density_chart: "Grafik Rapat Arus (Current Density)" 
            },
            en: { 
                nav_logs: "Data Logs", nav_trend: "Potential Graphs", nav_current: "Current & Density", nav_setup: "Research Setup", 
                sys_status: "System Status", last_sync: "Last Sync", start_date: "Start Date", 
                lbl_specimen: "Specimen", lbl_method: "Method", lbl_datatype: "Data Type", lbl_tulangan: "Rebar", 
                lbl_interval: "Time Interval", lbl_sort: "Time Sort", lbl_area: "Area (m²)", 
                opt_daily: "Daily", opt_3days: "Every 3 Days", opt_7days: "Every 7 Days", opt_14days: "Every 14 Days", opt_all: "All Specimens", 
                btn_export: "Export Excel", btn_save: "Save Config", btn_send: "Send to Device", 
                axis_days: "Exposure Time (Days)", axis_pot: "Potential (mV vs CSE)", axis_flow: "Current (mA)", axis_density: "Current Density (mA/m²)", axis_depol: "Depolarization (mV)",
                calib_title: "SPRCP Calibration", coeff_a: "Coefficient A", coeff_b: "Coefficient B", coeff_c: "Coefficient C", 
                rebar_1: "Rebar 1", rebar_2: "Rebar 2", lbl_on: "ON Potential", lbl_off: "Instant OFF", lbl_rest: "Rest Potential", lbl_depol: "Depolarization",
                th_time_ph1: "Time PH1", th_time_ph2: "Time PH2", th_time: "Time", th_sample: "Specimen", th_temp: "Temp", th_zone: "Zone", 
                th_depol: "DEPOL",
                sort_new: "Newest -> Oldest", sort_old: "Oldest -> Newest", 
                title_pot_chart: "Corrosion Potential Chart", 
                title_flow_chart: "Current Flow Chart", 
                title_density_chart: "Current Density Chart" 
            }
        };

        // AUTH & SYNC
        const initAuth = async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token); else await signInAnonymously(auth); } catch (error) { await signInAnonymously(auth); } };
        initAuth().then(() => { onAuthStateChanged(auth, (user) => { if (user) { startSync(); setTimeout(() => { loader.style.opacity = '0'; setTimeout(() => loader.classList.add('hidden'), 500); }, 1000); } }); });

        function startSync() {
            onValue(ref(db, `${basePath}/logs`), (s) => { rawLogs = s.exists() ? Object.values(s.val()) : []; window.renderLogTable(); if(currentTab==='trend') window.updateTrendChart(); });
            onValue(ref(db, `${basePath}/current_logs`), (s) => { currentLogs = s.exists() ? Object.values(s.val()) : []; if(currentTab==='current') { window.updateFlowChart(); window.updateDensityChart(); } });
            onValue(ref(db, `${basePath}/status_global`), (s) => { const d = s.val(); if(d) { document.getElementById('status-text').innerText = d.status==='PROTECTED'?'PROTECTED':'OFF'; document.getElementById('status-dot').className = `w-3 h-3 rounded-full transition-all duration-700 ${d.status==='PROTECTED'?'bg-emerald-500 shadow-[0_0_10px_#10b981]':'bg-rose-500'}`; document.getElementById('sync-time').innerText = `${d.last_update?.split(' ')[1]||'-'}`; }});
            onValue(ref(db, `${basePath}/research_config`), (s) => { if(s.val()) document.getElementById('display-start-date').innerText = s.val().start_date || 'N/A'; });
            
            // DOWNLOAD SEMUA DATA KALIBRASI
            onValue(ref(db, `${basePath}/kalibrasi`), (s) => { 
                allCalibrations = s.val() || {};
                updateCalibInputs(); 
            });
        }

        // --- KALIBRASI 32 SLOT LOGIC ---
        window.updateCalibInputs = () => {
            const bu = document.getElementById('calib-bu-select').value;
            const method = document.getElementById('calib-method-select').value;
            const tulangan = document.getElementById('calib-tul-select').value;
            
            // Format Key: "SACP_T1", "HCP_T2", dst
            const key = `${method}_${tulangan}`;
            
            // Ambil data dari tree: kalibrasi -> BU -> KEY -> a/b/c
            const data = allCalibrations[bu]?.[key] || { a: 0, b: 1, c: 0 }; 
            
            document.getElementById('poly-a').value = data.a !== undefined ? data.a : 0;
            document.getElementById('poly-b').value = data.b !== undefined ? data.b : 1;
            document.getElementById('poly-c').value = data.c !== undefined ? data.c : 0;
        };

        window.saveCalibration = () => {
            const bu = document.getElementById('calib-bu-select').value;
            const method = document.getElementById('calib-method-select').value;
            const tulangan = document.getElementById('calib-tul-select').value;
            const key = `${method}_${tulangan}`;

            const updates = {
                a: parseFloat(document.getElementById('poly-a').value),
                b: parseFloat(document.getElementById('poly-b').value),
                c: parseFloat(document.getElementById('poly-c').value)
            };
            
            // Simpan ke path spesifik
            set(ref(db, `${basePath}/kalibrasi/${bu}/${key}`), updates)
               .then(() => Swal.fire('Tersimpan', `Kalibrasi untuk ${bu} [${method} - ${tulangan}] berhasil disimpan.`, 'success'))
               .catch((e) => Swal.fire('Error', e.message, 'error'));
        };

        window.saveStartDate = () => {
            const dateStr = document.getElementById('setup-start-date').value;
            if(!dateStr) return;
            const timestamp = Math.floor(new Date(dateStr).getTime() / 1000);
            set(ref(db, `${basePath}/research_config/start_timestamp`), timestamp)
                .then(() => Swal.fire('Sukses', 'Tanggal mulai riset diperbarui', 'success'));
        };

        // --- HELPERS ---
        const calcFinalPotential = (sse, suhu) => { if (!sse || sse==='-' || isNaN(sse)) return null; const t = suhu||25; return parseFloat((parseFloat(sse) - 74.5 - (1.66 * (t - 25))).toFixed(1)); };
        const getTulangan = (tp) => tp.split('/')[0];

        // --- TAB SWITCHING ---
        function switchTab(tabId) {
            currentTab = tabId;
            ['logs', 'trend', 'current', 'setup'].forEach(t => { document.getElementById(`tab-${t}`).classList.add('hidden'); document.getElementById(`btn-${t}`).classList.remove('tab-active'); });
            document.getElementById(`tab-${tabId}`).classList.remove('hidden'); document.getElementById(`btn-${tabId}`).classList.add('tab-active');
            if(window.innerWidth < 1024) window.toggleSidebar();
            if(tabId === 'trend') { updateTrendOptions(); setTimeout(() => window.updateTrendChart(), 100); }
            if(tabId === 'current') { setTimeout(() => { window.updateFlowChart(); window.updateDensityChart(); }, 100); }
            const pt = document.getElementById('page-title'); if(pt) pt.innerText = i18n[currentLang][`nav_${tabId}`];
        }

        // --- LANGUAGE ---
        function setLanguage(lang) {
            currentLang = lang;
            document.getElementById('lang-id').className = lang === 'id' ? 'px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all bg-emerald-500 text-white shadow-md' : 'px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600';
            document.getElementById('lang-en').className = lang === 'en' ? 'px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all bg-emerald-500 text-white shadow-md' : 'px-2 md:px-3 py-1 rounded text-[10px] font-bold transition-all text-slate-400 hover:text-slate-600';
            document.querySelectorAll('[data-i18n]').forEach(el => { const key = el.getAttribute('data-i18n'); if(i18n[lang][key]) el.innerText = i18n[lang][key]; });
            const tulSelect = document.getElementById('trend-tulangan'); if(tulSelect && tulSelect.options.length >= 2) { tulSelect.options[0].text = i18n[lang].rebar_1; tulSelect.options[1].text = i18n[lang].rebar_2; }
            const sortSelect = document.getElementById('filter-sort'); if(sortSelect) { sortSelect.options[0].text = i18n[lang].sort_new; sortSelect.options[1].text = i18n[lang].sort_old; }
            [document.getElementById('filter-bu'), document.getElementById('trend-bu'), document.getElementById('current-bu')].forEach(sel => { if(sel) sel.options[0].text = i18n[lang].opt_all; });
            const intervalSelects = [document.getElementById('trend-interval'), document.getElementById('current-interval')];
            intervalSelects.forEach(sel => { if(sel) { sel.options[0].text = i18n[lang].opt_daily; sel.options[1].text = i18n[lang].opt_3days; sel.options[2].text = i18n[lang].opt_7days; sel.options[3].text = i18n[lang].opt_14days; } });
            window.renderLogTable(); if(currentTab === 'trend') window.updateTrendChart(); if(currentTab === 'current') { window.updateFlowChart(); window.updateDensityChart(); }
        }

        // --- TREND CHART LOGIC ---
        function updateTrendOptions() {
            const method = document.getElementById('trend-method').value;
            const sel = document.getElementById('trend-datatype');
            sel.innerHTML = method === 'SACP' 
                ? `<option value="on">${i18n[currentLang].lbl_on}</option><option value="off" selected>${i18n[currentLang].lbl_off}</option><option value="rest">${i18n[currentLang].lbl_rest}</option><option value="depol">${i18n[currentLang].lbl_depol}</option>` 
                : `<option value="hcp" selected>HCP</option>`;
            window.updateTrendChart();
        }

        window.updateTrendChart = () => {
            const bu = document.getElementById('trend-bu').value;
            const method = document.getElementById('trend-method').value;
            const dataType = document.getElementById('trend-datatype').value;
            const tulanganVal = document.getElementById('trend-tulangan').value;
            const interval = parseInt(document.getElementById('trend-interval').value);

            const buText = document.getElementById('trend-bu').options[document.getElementById('trend-bu').selectedIndex].text;
            const tulanganText = document.getElementById('trend-tulangan').options[document.getElementById('trend-tulangan').selectedIndex].text;
            const chartTitle = `${i18n[currentLang].title_pot_chart} - ${buText} - ${method} - ${tulanganText}`;

            let yLabel = i18n[currentLang].axis_pot;
            if(dataType === 'on') yLabel = `${i18n[currentLang].lbl_on} (mV vs CSE)`;
            if(dataType === 'off') yLabel = `${i18n[currentLang].lbl_off} (mV vs CSE)`;
            if(dataType === 'rest') yLabel = `${i18n[currentLang].lbl_rest} (mV vs CSE)`;
            if(dataType === 'hcp') yLabel = `HCP (mV vs CSE)`;
            if(dataType === 'depol') yLabel = i18n[currentLang].axis_depol;

            const zones = ['Patch Repair', 'Boundary', 'Existing'];
            const series = zones.map(z => ({ name: z, data: [] }));

            if (method === 'SACP' && dataType === 'depol') {
                const logs = rawLogs.filter(l => (bu === 'ALL' || l.bu === bu) && getTulangan(l.tp) === tulanganVal && (l.fase === 'PH1' || l.fase === 'PH2'));
                logs.sort((a,b) => a.timestamp - b.timestamp);

                const tpGroups = {};
                logs.forEach(l => { if(!tpGroups[l.tp]) tpGroups[l.tp] = []; tpGroups[l.tp].push(l); });

                const depolPoints = []; 
                Object.values(tpGroups).forEach(pointLogs => {
                    let pendingPH1 = null;
                    pointLogs.forEach(l => {
                        if(l.fase === 'PH1') { pendingPH1 = l; } 
                        else if(l.fase === 'PH2' && pendingPH1) {
                            const offVal = pendingPH1.off_avg; const restVal = l.v_off_avg || l.rest_avg;
                            const tOff = pendingPH1.suhu || 25; const tRest = l.suhu || 25;
                            if(offVal !== undefined && restVal !== undefined) {
                                const cseOff = calcFinalPotential(offVal, tOff); const cseRest = calcFinalPotential(restVal, tRest);
                                if(cseOff !== null && cseRest !== null) { depolPoints.push({ day: l.hari_ke, zone: l.tipe_titik, val: Math.abs(cseOff - cseRest) }); }
                            }
                        }
                    });
                });

                const zoneDaySums = {};
                depolPoints.forEach(p => {
                    let zoneName = p.zone; if(zoneName === 'Bounding') zoneName = 'Boundary';
                    const key = `${zoneName}-${p.day}`;
                    if(!zoneDaySums[key]) zoneDaySums[key] = { sum: 0, count: 0 };
                    zoneDaySums[key].sum += p.val; zoneDaySums[key].count++;
                });

                series.forEach(s => {
                    Object.keys(zoneDaySums).filter(k => k.startsWith(s.name + '-')).forEach(k => {
                        const day = parseInt(k.split('-')[1]);
                        if (day % interval === 0 || day === 1) { s.data.push({ x: day, y: parseFloat((zoneDaySums[k].sum / zoneDaySums[k].count).toFixed(1)) }); }
                    });
                    s.data.sort((a,b) => a.x - b.x);
                });

            } else {
                const dailyData = new Map();
                rawLogs.forEach(l => {
                    if (bu !== 'ALL' && l.bu !== bu) return;
                    if (getTulangan(l.tp) !== tulanganVal) return;
                    if(method === 'SACP' && (l.fase === 'PH1' || l.fase === 'PH2')) {} else if(method === 'HCP' && l.fase === 'HCP') {} else return;
                    let zName = l.tipe_titik; if(zName === 'Bounding') zName = 'Boundary';
                    const key = `${l.hari_ke}-${zName}`; 
                    if (!dailyData.has(key)) dailyData.set(key, { hari: l.hari_ke, sum: 0, count: 0, suhuSum: 0, suhuCount: 0 });
                    const entry = dailyData.get(key);
                    if(l.suhu) { entry.suhuSum += l.suhu; entry.suhuCount++; }
                    let val = null;
                    if(method === 'SACP') {
                        if(dataType === 'on' && l.fase === 'PH1') val = l.on_avg;
                        if(dataType === 'off' && l.fase === 'PH1') val = l.off_avg;
                        if(dataType === 'rest' && l.fase === 'PH2') { val = l.v_off_avg; if(val === undefined) val = l.rest_avg; }
                    } else { if(l.fase === 'HCP') val = l.hcp_avg || l.v_off_avg; }
                    if(val !== null && !isNaN(val)) { entry.sum += parseFloat(val); entry.count++; }
                });

                series.forEach(s => {
                    [...new Set(Array.from(dailyData.values()).map(d => d.hari))].sort((a,b) => a-b).filter(d => d % interval === 0 || d === 1).forEach(d => {
                        const searchKey = `${d}-${s.name}`; const entry = dailyData.get(searchKey);
                        if(entry && entry.count > 0) {
                            const rawAvg = entry.sum / entry.count; const tempAvg = entry.suhuCount > 0 ? entry.suhuSum / entry.suhuCount : 25;
                            const finalVal = calcFinalPotential(rawAvg, tempAvg); if (finalVal !== null) s.data.push({ x: d, y: finalVal });
                        }
                    });
                });
            }

            const colors = ['#10b981', '#f59e0b', '#3b82f6']; 
            const yMin = dataType === 'depol' ? 0 : -1200;
            const yMax = dataType === 'depol' ? undefined : 0; 

            const options = {
                series: series,
                chart: { type: 'line', height: '100%', fontFamily: 'Plus Jakarta Sans', toolbar: { show: true }, animations: { enabled: false } },
                title: { text: chartTitle, align: 'left', style: { fontSize: '14px', fontWeight: 'bold', color: '#1e293b' } },
                stroke: { width: 3, curve: 'straight' }, colors: colors,
                xaxis: { type: 'numeric', title: { text: i18n[currentLang].axis_days, style: { fontWeight: 700 } }, tickAmount: 'dataPoints', labels: { formatter: (val) => Math.round(val) } },
                yaxis: { min: yMin, max: yMax, tickAmount: 12, title: { text: yLabel, style: { fontWeight: 700, color: '#64748b' } }, labels: { formatter: (v) => v ? parseFloat(v).toFixed(0) : v } },
                markers: { size: 6, strokeWidth: 1, strokeColors: '#fff', fillOpacity: 1, showNullDataPoints: true, hover: { size: 8 } },
                grid: { borderColor: '#f1f5f9', padding: { left: 50, right: 50 } }, 
                tooltip: { shared: true, y: { formatter: (v) => v ? v + " mV" : "-" } }
            };
            if(trendChart) trendChart.destroy();
            const el = document.querySelector("#chart-trend");
            if(el) { trendChart = new ApexCharts(el, options); trendChart.render(); }
        };

        // --- CURRENT CHART LOGIC ---
        const processCurrentData = () => {
            const bu = document.getElementById('current-bu').value; const interval = parseInt(document.getElementById('current-interval').value); const area = parseFloat(document.getElementById('input-surface-area').value) || 1.0;
            const dailyData = new Map();
            currentLogs.forEach(l => {
                if (bu !== 'ALL' && l.bu !== bu) return;
                const dateStr = l.waktu_lokal?.split(' ')[0]; if(!dateStr) return;
                if(!dailyData.has(dateStr)) dailyData.set(dateStr, { hari: l.hari_ke, sum: 0, count: 0 });
                const e = dailyData.get(dateStr); if(l.i_ma) { e.sum += Math.abs(parseFloat(l.i_ma)); e.count++; }
            });
            let sortedDays = Array.from(dailyData.values()).sort((a,b) => a.hari - b.hari).filter(d => d.hari % interval === 0 || d.hari === 1);
            const flowData = [], densityData = [];
            sortedDays.forEach(d => {
                const avgMA = d.count > 0 ? d.sum / d.count : 0; const negMA = -1 * avgMA; 
                flowData.push({ x: d.hari, y: parseFloat(negMA.toFixed(2)) }); densityData.push({ x: d.hari, y: parseFloat((negMA / area).toFixed(3)) });
            });
            return { flowData, densityData };
        };

        window.updateFlowChart = () => {
            const { flowData } = processCurrentData(); const buName = document.getElementById('current-bu').options[document.getElementById('current-bu').selectedIndex].text;
            const options = { series: [{ name: 'Current Flow', data: flowData }], chart: { type: 'area', height: '100%', fontFamily: 'Plus Jakarta Sans', background: 'transparent', toolbar: { show: true }, animations: { enabled: false } }, title: { text: i18n[currentLang].title_flow_chart + ' - ' + buName, style: { color: '#fff', fontSize: '14px' } }, theme: { mode: 'dark' }, colors: ['#34d399'], stroke: { width: 3, curve: 'straight' }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.1 } }, xaxis: { type: 'numeric', title: { text: i18n[currentLang].axis_days, style: { color: '#94a3b8' } }, labels: { style: { colors: '#94a3b8' }, formatter: (val) => Math.round(val) }, tickAmount: 'dataPoints' }, yaxis: { title: { text: i18n[currentLang].axis_flow, style: { color: '#34d399' } }, labels: { style: { colors: '#94a3b8' } } }, markers: { size: 6, strokeWidth: 1, strokeColors: '#fff', fillOpacity: 1, showNullDataPoints: true }, grid: { borderColor: '#334155', padding: { left: 50, right: 50 } }, tooltip: { theme: 'dark', y: { formatter: (v) => v + " mA" } } };
            if(flowChart) flowChart.destroy(); const el = document.querySelector("#chart-flow"); if(el) { flowChart = new ApexCharts(el, options); flowChart.render(); }
        };

        window.updateDensityChart = () => {
            const { densityData } = processCurrentData(); const buName = document.getElementById('current-bu').options[document.getElementById('current-bu').selectedIndex].text;
            const options = { series: [{ name: 'Current Density', data: densityData }], chart: { type: 'area', height: '100%', fontFamily: 'Plus Jakarta Sans', background: 'transparent', toolbar: { show: true }, animations: { enabled: false } }, title: { text: i18n[currentLang].title_density_chart + ' - ' + buName, style: { color: '#fff', fontSize: '14px' } }, theme: { mode: 'dark' }, colors: ['#60a5fa'], stroke: { width: 3, curve: 'straight' }, fill: { type: 'gradient', gradient: { shadeIntensity: 1, opacityFrom: 0.6, opacityTo: 0.1 } }, xaxis: { type: 'numeric', title: { text: i18n[currentLang].axis_days, style: { color: '#94a3b8' } }, labels: { style: { colors: '#94a3b8' }, formatter: (val) => Math.round(val) }, tickAmount: 'dataPoints' }, yaxis: { title: { text: i18n[currentLang].axis_density, style: { color: '#60a5fa' } }, labels: { style: { colors: '#94a3b8' } } }, markers: { size: 6, strokeWidth: 1, strokeColors: '#fff', fillOpacity: 1, showNullDataPoints: true }, grid: { borderColor: '#334155', padding: { left: 50, right: 50 } }, tooltip: { theme: 'dark', y: { formatter: (v) => v + " mA/m²" } } };
            if(densityChart) densityChart.destroy(); const el = document.querySelector("#chart-density"); if(el) { densityChart = new ApexCharts(el, options); densityChart.render(); }
        };

        // --- TABLE LOGIC ---
        window.renderLogTable = () => {
            const filterBU = document.getElementById('filter-bu').value; const filterType = document.getElementById('filter-type').value; const sortOrder = document.getElementById('filter-sort').value;
            tableBody.innerHTML = "";
            const groupedData = new Map();
            rawLogs.forEach(l => {
                if (filterBU !== 'ALL' && l.bu !== filterBU) return;
                const aggKey = `${l.bu}-${l.tp}-${l.fase}-${l.hari_ke}`;
                if (!groupedData.has(aggKey)) { groupedData.set(aggKey, { bu: l.bu, tp: l.tp, fase: l.fase, hari: l.hari_ke, typePoint: l.tipe_titik, suhu: l.suhu || 25, waktu: l.waktu_lokal, timestamp: l.timestamp, vals: [] }); }
                const entry = groupedData.get(aggKey);
                if (l.fase === 'PH1') { entry.vals.push({ on1: l.on_1||l.v_on_1, on2: l.on_2||l.v_on_2, onAvg: l.on_avg, off1: l.off_1||l.v_off_1, off2: l.off_2||l.v_off_2, offAvg: l.off_avg }); }
                else if (l.fase === 'PH2') { entry.vals.push({ rest1: l.v_off_1, rest2: l.v_off_2, restAvg: l.v_off_avg || l.off_avg }); }
                else if (l.fase === 'HCP') { entry.vals.push({ hcp1: l.hcp_1 || l.v_off_1, hcp2: l.hcp_2 || l.v_off_2, hcpAvg: l.hcp_avg || l.off_avg || l.v_off_avg }); }
                if (l.timestamp > entry.timestamp) { entry.timestamp = l.timestamp; entry.waktu = l.waktu_lokal; }
            });
            const flatList = Array.from(groupedData.values()).map(d => {
                if (d.vals.length === 0) return d;
                const avg = (arr, key) => { const valid = arr.map(x => parseFloat(x[key])).filter(x => !isNaN(x)); return valid.length===0 ? '-' : valid.reduce((a,b)=>a+b,0)/valid.length; };
                if (d.fase === 'PH1') { d.on1 = avg(d.vals, 'on1'); d.on2 = avg(d.vals, 'on2'); d.onAvg = avg(d.vals, 'onAvg'); d.off1 = avg(d.vals, 'off1'); d.off2 = avg(d.vals, 'off2'); d.offAvg = avg(d.vals, 'offAvg'); }
                else if (d.fase === 'PH2') { d.rest1 = avg(d.vals, 'rest1'); d.rest2 = avg(d.vals, 'rest2'); d.restAvg = avg(d.vals, 'restAvg'); }
                else if (d.fase === 'HCP') { d.hcp1 = avg(d.vals, 'hcp1'); d.hcp2 = avg(d.vals, 'hcp2'); d.hcpAvg = avg(d.vals, 'hcpAvg'); }
                return d;
            });
            const sortByTimestamp = (a, b) => sortOrder === 'DESC' ? b.timestamp - a.timestamp : a.timestamp - b.timestamp;
            
            if(filterType === 'SACP') {
                const sacpLogs = flatList.filter(d => d.fase === 'PH1' || d.fase === 'PH2');
                const mergedRows = [], pendingPH1 = {}; 
                sacpLogs.sort((a, b) => a.timestamp - b.timestamp);
                sacpLogs.forEach(log => {
                    const key = `${log.bu}-${log.tp}`;
                    if (log.fase === 'PH1') { if (pendingPH1[key]) mergedRows.push(pendingPH1[key]); pendingPH1[key] = { ...log, waktuPH1: `Hari ${log.hari}`, waktuPH2: '-', rest1: '-', rest2: '-', restAvg: '-' }; }
                    else if (log.fase === 'PH2') { if (pendingPH1[key]) { const row = pendingPH1[key]; row.timestamp = Math.max(row.timestamp, log.timestamp); row.waktuPH2 = `Hari ${log.hari}`, row.rest1 = log.rest1; row.rest2 = log.rest2; row.restAvg = log.restAvg; mergedRows.push(row); delete pendingPH1[key]; } else { mergedRows.push({ ...log, waktuPH1: '-', waktuPH2: `Hari ${log.hari}`, on1: '-', on2: '-', onAvg: '-', off1: '-', off2: '-', offAvg: '-' }); } }
                });
                Object.values(pendingPH1).forEach(r => mergedRows.push(r));
                mergedRows.sort(sortByTimestamp);
                const groupSums = {};
                mergedRows.forEach(row => {
                    const tulangan = getTulangan(row.tp), timeKey = row.waktuPH1 !== '-' ? row.waktuPH1 : row.waktuPH2, groupKey = `${row.bu}-${tulangan}-${timeKey}`, typeKey = row.typePoint;
                    if(!groupSums[groupKey]) groupSums[groupKey] = {}; if(!groupSums[groupKey][typeKey]) groupSums[groupKey][typeKey] = { sumQ: 0, countQ: 0, sumT: 0, countT: 0, sumW: 0, countW: 0, sumS: 0, countS: 0 };
                    const e = groupSums[groupKey][typeKey];
                    if(row.onAvg!=='-' && !isNaN(row.onAvg)) { e.sumQ+=row.onAvg; e.countQ++; } if(row.offAvg!=='-' && !isNaN(row.offAvg)) { e.sumT+=row.offAvg; e.countT++; } if(row.restAvg!=='-' && !isNaN(row.restAvg)) { e.sumW+=row.restAvg; e.countW++; }
                    if(row.suhu !== undefined && !isNaN(row.suhu)) { e.sumS+=row.suhu; e.countS++; }
                });
                tableHead.innerHTML = `<tr class="bg-slate-100/50"><th class="px-3 py-4 sticky-col text-center">${i18n[currentLang].th_time_ph1}</th><th class="px-3 py-4 sticky-col border-l border-slate-100 text-center" style="left:100px">${i18n[currentLang].th_time_ph2}</th><th class="px-3 py-4 sticky-col border-l border-slate-100" style="left:200px">${i18n[currentLang].th_sample}</th><th class="px-3 py-4">${i18n[currentLang].th_temp}</th><th class="px-3 py-4 text-center">${i18n[currentLang].th_zone}</th><th class="px-3 py-4 text-blue-400 border-l border-slate-200">ON(1)</th><th class="px-3 py-4 text-blue-400">ON(2)</th><th class="px-3 py-4 text-emerald-400 border-l border-slate-200">OFF(1)</th><th class="px-3 py-4 text-emerald-400">OFF(2)</th><th class="px-3 py-4 text-amber-400 border-l border-slate-200">REST(1)</th><th class="px-3 py-4 text-amber-400">REST(2)</th><th class="px-3 py-4 text-blue-600 bg-blue-50 border-l border-blue-100">ON(Avg)</th><th class="px-3 py-4 text-blue-800 bg-blue-100 font-black border-l border-blue-200">SSE ON</th><th class="px-3 py-4 text-blue-900 bg-blue-200 font-black">CSE ON</th><th class="px-3 py-4 text-emerald-600 bg-emerald-50 border-l border-emerald-100">OFF(Avg)</th><th class="px-3 py-4 text-emerald-800 bg-emerald-100 font-black border-l border-emerald-200">SSE OFF</th><th class="px-3 py-4 text-emerald-900 bg-emerald-200 font-black">CSE OFF</th><th class="px-3 py-4 text-amber-600 bg-amber-50 border-l border-amber-100">REST(Avg)</th><th class="px-3 py-4 text-amber-800 bg-amber-100 font-black border-l border-amber-200">SSE REST</th><th class="px-3 py-4 text-amber-900 bg-amber-200 font-black">CSE REST</th><th class="px-3 py-4 text-purple-900 bg-purple-200 border-l border-purple-300 font-black">DEPOL</th></tr>`;
                
                mergedRows.forEach(d => {
                    const tr = document.createElement('tr'); tr.className = "hover:bg-emerald-50/30 transition-all border-b border-slate-100 text-slate-700 font-bold";
                    const fmt = (v) => (v !== '-' && !isNaN(v)) ? parseFloat(v).toFixed(2) : '-';

                    // CALCULATE SSE FROM GROUP SUMS
                    const tulangan = getTulangan(d.tp);
                    const timeKey = d.waktuPH1 !== '-' ? d.waktuPH1 : d.waktuPH2;
                    const groupKey = `${d.bu}-${tulangan}-${timeKey}`;
                    const stats = groupSums[groupKey]?.[d.typePoint];

                    const sseOn = (stats && stats.countQ > 0) ? stats.sumQ / stats.countQ : null;
                    const sseOff = (stats && stats.countT > 0) ? stats.sumT / stats.countT : null;
                    const sseRest = (stats && stats.countW > 0) ? stats.sumW / stats.countW : null;
                    const avgSuhu = (stats && stats.countS > 0) ? stats.sumS / stats.countS : d.suhu || 25;

                    let depolVal = '-';
                    if (sseOff !== null && sseRest !== null) {
                        const cseOff = calcFinalPotential(sseOff, avgSuhu); const cseRest = calcFinalPotential(sseRest, avgSuhu);
                        if (cseOff !== null && cseRest !== null) depolVal = Math.abs(cseOff - cseRest).toFixed(1);
                    }
                    tr.innerHTML = `<td class="px-3 py-3 sticky-col text-slate-900 font-black text-center">${d.waktuPH1}</td><td class="px-3 py-3 sticky-col border-l border-slate-100 text-slate-900 font-black text-center" style="left:100px">${d.waktuPH2}</td><td class="px-3 py-3 sticky-col border-l border-slate-100 text-slate-900 font-extrabold uppercase" style="left:200px">${d.bu}<br><span class="text-[9px] text-slate-400 font-mono">${d.tp}</span></td><td class="px-3 py-3 text-rose-500 text-center">${d.suhu.toFixed(1)}</td><td class="px-3 py-3 text-slate-400 text-[9px] font-bold italic uppercase text-center">${d.typePoint}</td><td class="px-3 py-3 border-l font-mono text-center text-blue-400">${fmt(d.on1)}</td><td class="px-3 py-3 font-mono text-center text-blue-400">${fmt(d.on2)}</td><td class="px-3 py-3 border-l font-mono text-center text-emerald-400">${fmt(d.off1)}</td><td class="px-3 py-3 font-mono text-center text-emerald-400">${fmt(d.off2)}</td><td class="px-3 py-3 border-l font-mono text-center text-amber-400">${fmt(d.rest1)}</td><td class="px-3 py-3 font-mono text-center text-amber-400">${fmt(d.rest2)}</td><td class="px-3 py-3 bg-blue-50 border-l font-mono text-blue-600">${fmt(d.onAvg)}</td><td class="px-3 py-3 bg-blue-100 border-l font-mono font-black text-blue-800 text-center">${fmt(sseOn)}</td><td class="px-3 py-3 bg-blue-200 font-mono font-black text-blue-900 text-center">${fmt(calcFinalPotential(sseOn, avgSuhu))}</td><td class="px-3 py-3 bg-emerald-50 border-l font-mono text-emerald-600">${fmt(d.offAvg)}</td><td class="px-3 py-3 bg-emerald-100 border-l font-mono font-black text-emerald-800 text-center">${fmt(sseOff)}</td><td class="px-3 py-3 bg-emerald-200 font-mono font-black text-emerald-900 text-center">${fmt(calcFinalPotential(sseOff, avgSuhu))}</td><td class="px-3 py-3 bg-amber-50 border-l font-mono text-amber-600">${fmt(d.restAvg)}</td><td class="px-3 py-3 bg-amber-100 border-l font-mono font-black text-amber-800 text-center">${fmt(sseRest)}</td><td class="px-3 py-3 bg-amber-200 font-mono font-black text-amber-900 text-center">${fmt(calcFinalPotential(sseRest, avgSuhu))}</td><td class="px-3 py-3 bg-purple-200 border-l border-purple-300 font-mono font-black text-purple-900 text-center">${depolVal}</td>`;
                    tableBody.appendChild(tr);
                });
            } else {
                const hcpLogs = flatList.filter(d => d.fase === 'HCP').sort(sortByTimestamp);
                const groupSumsHCP = {};
                hcpLogs.forEach(row => { 
                    if (row.hcpAvg === '-' || row.hcpAvg === undefined) return; 
                    const tulangan = getTulangan(row.tp), groupKey = `${row.bu}-${tulangan}-Hari ${row.hari}`, typeKey = row.typePoint; 
                    if(!groupSumsHCP[groupKey]) groupSumsHCP[groupKey] = {}; 
                    if(!groupSumsHCP[groupKey][typeKey]) groupSumsHCP[groupKey][typeKey] = { sum: 0, count: 0, sumS: 0, countS: 0 }; 
                    groupSumsHCP[groupKey][typeKey].sum += row.hcpAvg; 
                    groupSumsHCP[groupKey][typeKey].count++; 
                    if (row.suhu !== undefined && !isNaN(row.suhu)) { groupSumsHCP[groupKey][typeKey].sumS += row.suhu; groupSumsHCP[groupKey][typeKey].countS++; }
                });
                tableHead.innerHTML = `<tr class="bg-slate-100/50"><th class="px-5 py-4 sticky-col text-center">${i18n[currentLang].th_time}</th><th class="px-5 py-4 sticky-col" style="left:80px">${i18n[currentLang].th_sample}</th><th class="px-5 py-4">${i18n[currentLang].th_temp}</th><th class="px-5 py-4 text-center">${i18n[currentLang].th_zone}</th><th class="px-5 py-4 border-l border-slate-200 text-rose-400">HCP(1)</th><th class="px-5 py-4 text-rose-400">HCP(2)</th><th class="px-5 py-4 bg-rose-50 text-rose-600 border-l-2 border-rose-200 text-center">HCP(Avg)</th><th class="px-5 py-4 bg-rose-100 text-rose-900 text-center font-black border-l border-rose-300">SSE HCP</th><th class="px-5 py-4 bg-rose-200 text-rose-950 text-center font-black">CSE HCP</th></tr>`;
                hcpLogs.forEach(d => {
                    if (d.hcpAvg === '-' || d.hcpAvg === undefined) return;
                    const tr = document.createElement('tr'); tr.className = "hover:bg-emerald-50/30 transition-all border-b border-slate-100 text-slate-700 font-bold";
                    const fmt = (v) => (v !== '-' && !isNaN(v)) ? parseFloat(v).toFixed(2) : '-';
                    const tulangan = getTulangan(d.tp), groupKey = `${d.bu}-${tulangan}-Hari ${d.hari}`, stats = groupSumsHCP[groupKey]?.[d.typePoint];
                    const sseHcp = stats&&stats.count>0?stats.sum/stats.count:null;
                    const avgSuhuHcp = stats&&stats.countS>0?stats.sumS/stats.countS : d.suhu || 25;
                    tr.innerHTML = `<td class="px-5 py-4 sticky-col text-slate-900 font-black text-center">Hari ${d.hari}</td><td class="px-5 py-4 sticky-col text-slate-900 font-extrabold uppercase" style="left:80px">${d.bu}<br><span class="text-[9px] text-slate-400 font-mono">${d.tp}</span></td><td class="px-5 py-4 text-rose-500 text-center">${d.suhu.toFixed(1)}</td><td class="px-5 py-4 text-slate-400 text-[9px] font-bold italic uppercase text-center">${d.typePoint}</td><td class="px-5 py-4 text-center border-l font-mono text-center">${fmt(d.hcp1)}</td><td class="px-5 py-4 text-center font-mono text-center text-center">${fmt(d.hcp2)}</td><td class="px-5 py-4 text-center bg-rose-50 text-rose-600 border-l-2 font-black text-center">${fmt(d.hcpAvg)}</td><td class="px-5 py-4 text-center bg-rose-100 text-rose-900 border-l font-black text-center">${fmt(sseHcp)}</td><td class="px-5 py-4 text-center bg-rose-200 text-rose-950 font-black text-xs text-center">${fmt(calcFinalPotential(sseHcp, avgSuhuHcp))}</td>`;
                    tableBody.appendChild(tr);
                });
            }
        };

        window.exportToExcel = () => {
            const table = document.querySelector('table');
            const wb = XLSX.utils.table_to_book(table, {sheet: "Data Log"});
            XLSX.writeFile(wb, `SPRCP_Data_${new Date().toISOString().slice(0,10)}.xlsx`);
        };

        // EVENT LISTENERS
        document.getElementById('btn-logs').addEventListener('click', () => switchTab('logs'));
        document.getElementById('btn-trend').addEventListener('click', () => switchTab('trend'));
        document.getElementById('btn-current').addEventListener('click', () => switchTab('current'));
        document.getElementById('btn-setup').addEventListener('click', () => switchTab('setup'));
        document.getElementById('lang-id').addEventListener('click', () => setLanguage('id'));
        document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
        document.getElementById('filter-bu').addEventListener('change', window.renderLogTable);
        document.getElementById('filter-type').addEventListener('change', window.renderLogTable);
        document.getElementById('filter-sort').addEventListener('change', window.renderLogTable);
        document.getElementById('btn-export').addEventListener('click', window.exportToExcel);
        document.getElementById('trend-bu').addEventListener('change', window.updateTrendChart);
        document.getElementById('trend-method').addEventListener('change', () => { updateTrendOptions(); window.updateTrendChart(); });
        document.getElementById('trend-datatype').addEventListener('change', window.updateTrendChart);
        document.getElementById('trend-tulangan').addEventListener('change', window.updateTrendChart);
        document.getElementById('trend-interval').addEventListener('change', window.updateTrendChart);
        document.getElementById('current-bu').addEventListener('change', () => { window.updateFlowChart(); window.updateDensityChart(); });
        document.getElementById('current-interval').addEventListener('change', () => { window.updateFlowChart(); window.updateDensityChart(); });
        document.getElementById('input-surface-area').addEventListener('change', window.updateDensityChart);
        document.getElementById('btn-save-date').addEventListener('click', window.saveStartDate);
        document.getElementById('btn-save-calib').addEventListener('click', window.saveCalibration);
        document.getElementById('calib-bu-select').addEventListener('change', window.updateCalibInputs);
        document.getElementById('calib-method-select').addEventListener('change', window.updateCalibInputs);
        document.getElementById('calib-tul-select').addEventListener('change', window.updateCalibInputs);

        switchTab('logs');
        updateTrendOptions();
    </script>
</body>
</html>